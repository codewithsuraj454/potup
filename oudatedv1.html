
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Potup</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>@import url('https://fonts.googleapis.com/css2?family=Edu+NSW+ACT+Cursive:wght@400..700&display=swap');</style>
<link rel="icon" type="image/png" href="ChatGPT_Image_Dec_12__2025__03_11_52_PM__1_-removebg-preview.png">

<style>
* { 
  box-sizing: border-box; 
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
}

:root {
  --bg-primary: #000000;
  --bg-secondary: #16181c;
  --bg-hover: #1d1f23;
  --border-color: #2f3336;
  --text-primary: #e7e9ea;
  --text-secondary: #71767b;
  --accent: #1d9bf0;
  --accent-hover: #1a8cd8;
  --verified: #1d9bf0;
  --elite: #ff8c00;
  --founder: #ef4444;
  --ad: #fbbf24;
  --active: #10b981;
  --ai-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
}

body.light-mode {
  --bg-primary: #ffffff;
  --bg-secondary: #f7f9f9;
  --bg-hover: #f0f0f0;
  --border-color: #eff3f4;
  --text-primary: #0f1419;
  --text-secondary: #536471;
}

body { 
  background: var(--bg-primary);
  color: var(--text-primary);
  display: flex;
  min-height: 100vh;
  transition: all 0.3s ease;
  overflow-x: hidden;
}

/* DESKTOP NAVBAR */
nav {
  width: 275px;
  background: var(--bg-primary);
  padding: 20px;
  height: 100vh;
  border-right: 1px solid var(--border-color);
  position: sticky;
  top: 0;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}

nav h1 { 
  color: var(--accent);
  margin-bottom: 10px;
  margin-left: 45px;
  font-size: 32px;
  font-weight: 800;
  letter-spacing: -0.5px;
  font-family: "Edu NSW ACT Cursive", cursive;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 20px;
  padding: 12px 20px;
  margin: 5px 0;
  cursor: pointer;
  border-radius: 30px;
  font-size: 20px;
  font-weight: 500;
  transition: all 0.2s;
  position: relative;
}

.nav-item:hover {
  background: var(--bg-hover);
}

.nav-item.active {
  font-weight: 700;
}

.nav-item .material-icons {
  font-size: 26px;
}

.nav-item.ai-nav {
  background: var(--ai-gradient);
  color: white;
  font-weight: 600;
}

.nav-item.ai-nav:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

.notification-badge {
  position: absolute;
  top: 8px;
  left: 35px;
  background: var(--founder);
  color: white;
  font-size: 11px;
  font-weight: 700;
  min-width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 4px;
}

/* MOBILE BOTTOM NAV */
.mobile-nav {
  display: none;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-primary);
  border-top: 1px solid var(--border-color);
  padding: 8px 0;
  z-index: 100;
  backdrop-filter: blur(12px);
}

.mobile-nav-items {
  display: flex;
  justify-content: space-around;
  align-items: center;
}

.mobile-nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 8px 16px;
  cursor: pointer;
  border-radius: 12px;
  transition: all 0.2s;
  position: relative;
}

.mobile-nav-item.active {
  color: var(--accent);
}

.mobile-nav-item .material-icons {
  font-size: 24px;
}

.mobile-nav-item span:not(.material-icons) {
  font-size: 11px;
  font-weight: 600;
}

.mobile-notification-badge {
  position: absolute;
  top: 4px;
  right: 12px;
  background: var(--founder);
  color: white;
  font-size: 10px;
  font-weight: 700;
  min-width: 16px;
  height: 16px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 4px;
}

main { 
  flex: 1;
  display: flex;
  max-width: 1280px;
  margin: 0 auto;
  width: 100%;
}

.page {
  display: none !important;
}

.page.active {
  display: flex !important;
  flex: 1;
}

#homePage.active,
#aiPage.active,
#profilePage.active,
#notificationsPage.active,
#settingsPage.active,
#viewProfilePage.active {
  display: flex !important;
}

#homePage,
#aiPage {
  flex: 1;
}

.feed-container {
  flex: 1;
  border-right: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

.page-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-color);
  backdrop-filter: blur(12px);
  background: rgba(0, 0, 0, 0.65);
  z-index: 10;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
}

body.light-mode .page-header {
  background: rgba(255, 255, 255, 0.85);
}

.page-header h2 {
  font-size: 20px;
  font-weight: 800;
}

.header-actions {
  display: flex;
  gap: 8px;
}

.icon-btn-header {
  background: transparent;
  border: 1px solid var(--border-color);
  color: var(--text-primary);
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 20px;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
  font-size: 14px;
  font-weight: 600;
}

.icon-btn-header:hover {
  background: var(--bg-hover);
}

.feed-scroll-area {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

#feed { 
  min-height: 100%;
  padding-bottom: 80px;
}

.post-composer {
  padding: 16px 20px;
  border-bottom: 8px solid var(--border-color);
}

.composer-wrapper {
  display: flex;
  gap: 12px;
}

.composer-wrapper img {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
}

.composer-content {
  flex: 1;
  position: relative;
}

.composer-content textarea {
  width: 100%;
  padding: 12px 0;
  border: none;
  background: transparent;
  color: var(--text-primary);
  font-size: 18px;
  resize: none;
  outline: none;
  font-family: 'Inter', sans-serif;
}

.composer-content textarea::placeholder {
  color: var(--text-secondary);
}

.category-selector {
  margin: 12px 0;
  padding: 12px;
  background: var(--bg-secondary);
  border-radius: 12px;
  border: 1px solid var(--border-color);
}

.category-selector label {
  display: block;
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 8px;
  font-weight: 600;
}

.category-options {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.category-option {
  padding: 6px 14px;
  border: 1px solid var(--border-color);
  border-radius: 20px;
  background: transparent;
  color: var(--text-primary);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
}

.category-option:hover,
.category-option:active {
  background: var(--bg-hover);
  border-color: var(--accent);
}

.category-option.selected {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
}

.composer-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
}

.composer-icons {
  display: flex;
  gap: 8px;
}

.icon-btn {
  background: transparent;
  border: none;
  color: var(--accent);
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  transition: all 0.2s;
}

.icon-btn:hover,
.icon-btn:active {
  background: rgba(29, 155, 240, 0.1);
}

.post-btn {
  padding: 8px 24px;
  border: none;
  border-radius: 30px;
  background: var(--accent);
  color: white;
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s;
}

.post-btn:hover,
.post-btn:active {
  background: var(--accent-hover);
}

.post-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.post {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-color);
  transition: background 0.2s;
  cursor: pointer;
}

.post:active {
  background: var(--bg-hover);
}

.post-content-wrapper {
  display: flex;
  gap: 12px;
}

.post-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
}

.post-main {
  flex: 1;
  min-width: 0;
}

.post-header {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
  flex-wrap: wrap;
}

.username {
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
}

.username:active {
  text-decoration: underline;
}

.post-time {
  color: var(--text-secondary);
  font-size: 15px;
}

.post-category {
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 10px;
  background: var(--bg-secondary);
  color: var(--accent);
  margin-left: auto;
  font-weight: 600;
}

.post-text {
  font-size: 15px;
  line-height: 20px;
  margin: 4px 0 12px 0;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.post-img {
  max-width: 100%;
  border-radius: 16px;
  margin-top: 12px;
  border: 1px solid var(--border-color);
  display: block;
}

.badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 700;
  margin-left: 4px;
}

.badge.verified {
  background: rgba(29, 155, 240, 0.2);
  color: var(--verified);
}

.badge.elite {
  background: rgba(255, 140, 0, 0.2);
  color: var(--elite);
}

.badge.founder {
  background: rgba(239, 68, 68, 0.2);
  color: var(--founder);
}

.badge.ad {
  background: rgba(251, 191, 36, 0.2);
  color: var(--ad);
}

.badge.active {
  background: rgba(16, 185, 129, 0.2);
  color: var(--active);
}

#newsBar {
  width: 350px;
  padding: 20px;
  height: 100vh;
  position: sticky;
  top: 0;
  overflow: hidden;
}

.news-widget {
  background: var(--bg-secondary);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 16px;
}

.news-widget h3 {
  font-size: 20px;
  font-weight: 800;
  margin-bottom: 16px;
}

.news-item {
  padding: 12px 0;
  cursor: pointer;
}

.news-item:active {
  opacity: 0.8;
}

.news-category {
  font-size: 13px;
  color: var(--text-secondary);
}

.news-title {
  font-size: 15px;
  font-weight: 600;
  margin: 4px 0;
}

.news-stats {
  font-size: 13px;
  color: var(--text-secondary);
}

#profilePage,
#viewProfilePage {
  flex: 1;
  max-width: 1000px;
  overflow-y: auto;
  height: 100vh;
  -webkit-overflow-scrolling: touch;
}

.profile-banner {
  height: 200px;
  background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
  position: relative;
}

.profile-info {
  padding: 0 20px;
  position: relative;
}

.profile-avatar {
  width: 134px;
  height: 134px;
  border-radius: 50%;
  border: 4px solid var(--bg-primary);
  margin-top: -67px;
  object-fit: cover;
  cursor: pointer;
}

.profile-avatar:active {
  opacity: 0.9;
}

.edit-profile-btn {
  position: absolute;
  right: 20px;
  top: -50px;
  padding: 8px 16px;
  border: 1px solid var(--border-color);
  border-radius: 30px;
  background: var(--bg-primary);
  color: var(--text-primary);
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
}

.profile-details {
  margin-top: 12px;
}

.profile-name {
  font-size: 20px;
  font-weight: 800;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.profile-username {
  font-size: 15px;
  color: var(--text-secondary);
}

.profile-bio {
  margin: 12px 0;
  font-size: 15px;
  line-height: 20px;
}

.profile-stats {
  display: flex;
  gap: 20px;
  margin: 12px 0;
  padding: 16px 0;
  border-top: 1px solid var(--border-color);
}

.stat {
  cursor: pointer;
}

.stat:active .stat-label {
  text-decoration: underline;
}

.stat-value {
  font-weight: 700;
  font-size: 15px;
}

.stat-label {
  color: var(--text-secondary);
  font-size: 15px;
}

.interests-section {
  margin: 10px 0;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: 16px;
  margin-bottom: 20px;
}

.interests-section h3 {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 12px;
}

.interests-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.interest-chip {
  padding: 8px 16px;
  border: 2px solid var(--border-color);
  border-radius: 25px;
  background: transparent;
  color: var(--text-primary);
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
}

.interest-chip:active {
  border-color: var(--accent);
}

.interest-chip.selected {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
}

.interest-chip:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.interests-info {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 10px;
}

.profile-posts-section {
  margin-top: 20px;
  border-top: 1px solid var(--border-color);
  padding-bottom: 80px;
}

.profile-posts-header {
  padding: 16px 20px;
  font-size: 18px;
  font-weight: 700;
  border-bottom: 1px solid var(--border-color);
  position: sticky;
  top: 0;
  background: var(--bg-primary);
  z-index: 5;
}

#notificationsPage {
  flex: 1;
  max-width: 1000px;
  overflow-y: auto;
  height: 100vh;
  -webkit-overflow-scrolling: touch;
}

#notificationsList {
  padding-bottom: 80px;
}

.notification-item {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: background 0.2s;
}

.notification-item:active {
  background: var(--bg-hover);
}

.notification-item.unread {
  background: rgba(29, 155, 240, 0.05);
}

.notification-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-secondary);
  flex-shrink: 0;
}

.notification-icon.follow {
  background: rgba(29, 155, 240, 0.2);
  color: var(--accent);
}

.notification-icon.system {
  background: rgba(139, 92, 246, 0.2);
  color: #8b5cf6;
}

.notification-content {
  flex: 1;
  min-width: 0;
}

.notification-text {
  font-size: 15px;
  line-height: 20px;
}

.notification-text strong {
  font-weight: 700;
}

.notification-time {
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 4px;
}

.no-notifications {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}

/* AI PAGE */
#aiPage {
  flex: 1;
  max-width: 1000px;
  height: 100vh;
}

.ai-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  height: 100%;
}

.ai-header {
  padding: 24px 20px;
  border-bottom: 1px solid var(--border-color);
  text-align: center;
  flex-shrink: 0;
  background: var(--bg-secondary);
}

.ai-header h2 {
  background: var(--ai-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-size: 28px;
  font-weight: 800;
  margin-bottom: 8px;
}

.ai-header p {
  color: var(--text-secondary);
  font-size: 14px;
}

.ai-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: var(--bg-primary);
  -webkit-overflow-scrolling: touch;
  padding-bottom: 80px;
}

.ai-message {
  margin-bottom: 20px;
  display: flex;
  gap: 12px;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.ai-message.user {
  flex-direction: row-reverse;
}

.ai-message-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.ai-message.assistant .ai-message-avatar {
  background: var(--ai-gradient);
  color: white;
}

.ai-message.user .ai-message-avatar {
  background: var(--accent);
  color: white;
}

.ai-message-bubble {
  max-width: 70%;
  padding: 14px 18px;
  border-radius: 20px;
  font-size: 15px;
  line-height: 22px;
  word-wrap: break-word;
}

.ai-message.assistant .ai-message-bubble {
  background: var(--bg-secondary);
  border-bottom-left-radius: 4px;
  border: 1px solid var(--border-color);
}

.ai-message.user .ai-message-bubble {
  background: var(--accent);
  color: white;
  border-bottom-right-radius: 4px;
}

.ai-input-container {
  padding: 16px 20px;
  padding-bottom: 80px;
  border-top: 1px solid var(--border-color);
  display: flex;
  gap: 12px;
  flex-shrink: 0;
  background: var(--bg-secondary);
}

.ai-input {
  flex: 1;
  padding: 12px 20px;
  border: 1px solid var(--border-color);
  border-radius: 25px;
  background: var(--bg-primary);
  color: var(--text-primary);
  font-size: 15px;
  outline: none;
  transition: all 0.2s;
}

.ai-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(29, 155, 240, 0.1);
}

.ai-send-btn {
  width: 48px;
  height: 48px;
  border: none;
  border-radius: 50%;
  background: var(--ai-gradient);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  flex-shrink: 0;
}

.ai-send-btn:active {
  transform: scale(0.95);
}

.ai-send-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.ai-typing {
  display: flex;
  gap: 4px;
  padding: 12px 16px;
}

.ai-typing span {
  width: 8px;
  height: 8px;
  background: var(--text-secondary);
  border-radius: 50%;
  animation: typing 1.4s infinite ease-in-out;
}

.ai-typing span:nth-child(2) {
  animation-delay: 0.2s;
}

.ai-typing span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% {
    transform: translateY(0);
  }
  30% {
    transform: translateY(-8px);
  }
}

#settingsPage {
  flex: 1;
  max-width: 800px;
  overflow-y: auto;
  height: 100vh;
  -webkit-overflow-scrolling: touch;
}

.settings-section {
  border-bottom: 1px solid var(--border-color);
}

.settings-item {
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  transition: background 0.2s;
}

.settings-item:active {
  background: var(--bg-hover);
}

.settings-item-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.settings-item-text h4 {
  font-size: 15px;
  font-weight: 700;
}

.settings-item-text p {
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 2px;
}

.toggle-switch {
  position: relative;
  width: 44px;
  height: 24px;
  flex-shrink: 0;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--text-secondary);
  border-radius: 24px;
  transition: 0.3s;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background: white;
  border-radius: 50%;
  transition: 0.3s;
}

input:checked + .toggle-slider {
  background: var(--accent);
}

input:checked + .toggle-slider:before {
  transform: translateX(20px);
}

#profileModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  justify-content: center;
  align-items: center;
  z-index: 1000;
  padding: 20px;
}

.modal-box {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  padding: 32px;
  max-width: 400px;
  width: 100%;
  border-radius: 16px;
  position: relative;
  max-height: 90vh;
  overflow-y: auto;
}

.close {
  position: absolute;
  top: 16px;
  right: 16px;
  cursor: pointer;
  font-size: 24px;
  color: var(--text-secondary);
}

.close:active {
  color: var(--text-primary);
}

.modal-avatar {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  margin: 0 auto 16px;
  display: block;
  object-fit: cover;
}

.modal-content {
  text-align: center;
}

.modal-username {
  font-size: 20px;
  font-weight: 800;
  margin-bottom: 8px;
}

.modal-badges {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 8px;
  margin: 12px 0;
}

.modal-bio {
  color: var(--text-secondary);
  margin: 16px 0;
  line-height: 20px;
}

.modal-actions {
  display: flex;
  gap: 8px;
  margin-top: 16px;
}

.modal-follow-btn,
.modal-share-btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 30px;
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s;
}

.modal-follow-btn {
  background: var(--text-primary);
  color: var(--bg-primary);
}

.modal-follow-btn:active {
  opacity: 0.9;
}

.modal-share-btn {
  background: transparent;
  border: 1px solid var(--border-color);
  color: var(--text-primary);
}

.modal-share-btn:active {
  background: var(--bg-hover);
}

.hidden {
  display: none !important;
}

input[type="file"] {
  display: none;
}

#emojiPicker {
  position: absolute;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  width: 320px;
  max-width: 90vw;
  max-height: 400px;
  overflow-y: auto;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  z-index: 1000;
  margin-top: 8px;
  display: none;
}

#emojiGrid {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 4px;
  padding: 12px;
}

.emoji-btn-item {
  background: transparent;
  border: none;
  font-size: 24px;
  padding: 8px;
  cursor: pointer;
  border-radius: 8px;
  transition: all 0.2s;
}

.emoji-btn-item:active {
  background: var(--bg-hover);
  transform: scale(1.2);
}

#emojiPicker::-webkit-scrollbar {
  width: 8px;
}

#emojiPicker::-webkit-scrollbar-track {
  background: var(--bg-secondary);
}

#emojiPicker::-webkit-scrollbar-thumb {
  background: var(--border-color);
  border-radius: 4px;
}

.loading-spinner {
  display: flex;
  justify-content: center;
  padding: 20px;
}

.spinner {
  width: 30px;
  height: 30px;
  border: 3px solid var(--border-color);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}

/* MOBILE RESPONSIVENESS */
@media (max-width: 1200px) {
  #newsBar {
    display: none;
  }
}

@media (max-width: 768px) {
  nav {
    display: none;
  }
  
  .mobile-nav {
    display: block;
  }
  
  main {
    padding-bottom: 0;
  }
  
  .feed-container {
    border-right: none;
  }
  
  #feed,
  .profile-posts-section,
  #notificationsList,
  .ai-messages {
    padding-bottom: 70px;
  }
  
  .ai-input-container {
    padding-bottom: 70px;
  }
  
  .page-header {
    padding: 12px 16px;
  }
  
  .page-header h2 {
    font-size: 18px;
  }
  
  .icon-btn-header {
    padding: 6px 10px;
    font-size: 13px;
  }
  
  .icon-btn-header .material-icons {
    font-size: 18px;
  }
  
  .post-composer {
    padding: 12px 16px;
  }
  
  .composer-wrapper img {
    width: 40px;
    height: 40px;
  }
  
  .composer-content textarea {
    font-size: 16px;
  }
  
  .category-selector {
    padding: 10px;
  }
  
  .post {
    padding: 12px 16px;
  }
  
  .profile-banner {
    height: 150px;
  }
  
  .profile-avatar {
    width: 100px;
    height: 100px;
    margin-top: -50px;
  }
  
  .profile-info {
    padding: 0 16px;
  }
  
  .ai-header {
    padding: 20px 16px;
  }
  
  .ai-header h2 {
    font-size: 24px;
  }
  
  .ai-messages {
    padding: 16px;
  }
  
  .ai-message-bubble {
    max-width: 80%;
    font-size: 14px;
  }
  
  .modal-box {
    padding: 24px;
    margin: 20px;
  }
  
  #emojiGrid {
    grid-template-columns: repeat(6, 1fr);
  }
}

@media (max-width: 480px) {
  .composer-content textarea {
    font-size: 15px;
  }
  
  .post-text {
    font-size: 14px;
  }
  
  .username {
    font-size: 14px;
  }
  
  .post-time {
    font-size: 13px;
  }
  
  .category-option {
    font-size: 12px;
    padding: 5px 12px;
  }
  
  .interest-chip {
    font-size: 13px;
    padding: 6px 12px;
  }
  
  .ai-message-bubble {
    font-size: 14px;
    padding: 12px 14px;
  }
  
  #emojiGrid {
    grid-template-columns: repeat(6, 1fr);
  }
  
  .emoji-btn-item {
    font-size: 20px;
    padding: 6px;
  }
}
.post-actions {
  margin-top: 8px;
}

.like-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px 0;
  color: var(--text-secondary);
  font-size: 14px;
}

.like-btn.liked {
  color: #f91880;
}

.like-btn .material-icons {
  font-size: 20px;
}
.post-actions {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-top: 12px;
  padding-top: 8px;
}

.action-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  background: transparent;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 6px 10px;
  border-radius: 20px;
  font-size: 14px;
  transition: all 0.2s;
  font-weight: 500;
}

.action-btn:hover,
.action-btn:active {
  background: rgba(239, 68, 68, 0.1);
}

.action-btn.liked {
  color: var(--founder);
}

.action-btn .material-icons {
  font-size: 18px;
  transition: all 0.2s;
}

.action-btn:hover .material-icons,
.action-btn:active .material-icons {
  color: var(--founder);
}

.action-btn.liked .material-icons {
  color: var(--founder);
}

.like-count {
  font-size: 14px;
  min-width: 20px;
  text-align: left;
}

</style>
</head>

<body>

<!-- DESKTOP NAV -->
<nav>
  <h1>Potup</h1>
  
  <div class="nav-item active" data-page="homePage">
    <span class="material-icons">home</span>
    <span>Home</span>
  </div>
  
  <div class="nav-item ai-nav" data-page="aiPage">
    <span class="material-icons">auto_awesome</span>
    <span>Potup AI</span>
  </div>
  
  <div class="nav-item" data-page="notificationsPage">
    <span class="material-icons">notifications</span>
    <span>Notifications</span>
    <span id="notificationBadge" class="notification-badge hidden">0</span>
  </div>
  
  <div class="nav-item" data-page="profilePage">
    <span class="material-icons">person</span>
    <span>Profile</span>
  </div>
  
  <div class="nav-item" data-page="settingsPage">
    <span class="material-icons">settings</span>
    <span>Settings</span>
  </div>
</nav>

<!-- MOBILE BOTTOM NAV -->
<div class="mobile-nav">
  <div class="mobile-nav-items">
    <div class="mobile-nav-item active" data-page="homePage">
      <span class="material-icons">home</span>
    </div>
    
    <div class="mobile-nav-item" data-page="aiPage">
      <span class="material-icons">auto_awesome</span>
    </div>
    
    <div class="mobile-nav-item" data-page="notificationsPage">
      <span class="material-icons">notifications</span>
      <span id="mobileNotificationBadge" class="mobile-notification-badge hidden">0</span>
    </div>
    
    <div class="mobile-nav-item" data-page="profilePage">
      <span class="material-icons">person</span>
    </div>
    
    <div class="mobile-nav-item" data-page="settingsPage">
      <span class="material-icons">settings</span>
    </div>
  </div>
</div>

<main>
  <!-- HOME PAGE -->
  <div id="homePage" class="page active">
    <div class="feed-container">
      <div class="page-header">
        <h2>Home</h2>
      </div>

      <div class="feed-scroll-area">
        <div class="post-composer">
          <div class="composer-wrapper">
            <img id="composerAvatar" src="https://i.imgur.com/6VBx3io.png">
            <div class="composer-content">
              <textarea id="postContent" placeholder="What's happening?" rows="3"></textarea>
              
              <div class="category-selector">
                <label>Select a category for your post *</label>
                <div class="category-options" id="postCategoryOptions">
                  <button type="button" class="category-option" data-category="fun">üéâ Fun</button>
                  <button type="button" class="category-option" data-category="motivation">üí™ Motivation</button>
                  <button type="button" class="category-option" data-category="education">üìö Education</button>
                  <button type="button" class="category-option" data-category="tech">üíª Tech</button>
                  <button type="button" class="category-option" data-category="nature">üåø Nature</button>
                  <button type="button" class="category-option" data-category="space">üöÄ Space</button>
                  <button type="button" class="category-option" data-category="interesting">‚ú® Interesting</button>
                  <button type="button" class="category-option" data-category="other">üìù Other</button>
                </div>
              </div>
              
              <div class="composer-actions">
                <div class="composer-icons">
                  <button id="emojiBtn" class="icon-btn" type="button">
                    <span class="material-icons">sentiment_satisfied_alt</span>
                  </button>
                  <label for="postImage" class="icon-btn">
                    <span class="material-icons">image</span>
                  </label>
                  <input type="file" id="postImage" accept="image/*">
                </div>
                <button class="post-btn" onclick="createPost()">Post</button>
              </div>
              
              <div id="emojiPicker">
                <div id="emojiGrid"></div>
              </div>
            </div>
          </div>
        </div>

        <div id="feed"></div>
      </div>
    </div>

    <div id="newsBar">
      <div class="news-widget">
        <h3>What's happening</h3>
        <div class="news-item">
          <div class="news-category">Technology ¬∑ Trending</div>
          <div class="news-title">AI Development Updates</div>
          <div class="news-stats">12.5K posts</div>
        </div>
        <div class="news-item">
          <div class="news-category">Sports ¬∑ Live</div>
          <div class="news-title">Major Championship Finals</div>
          <div class="news-stats">45K posts</div>
        </div>
        <div class="news-item">
          <div class="news-category">Entertainment ¬∑ Trending</div>
          <div class="news-title">New Movie Release</div>
          <div class="news-stats">8.2K posts</div>
        </div>
      </div>
      
      <div class="news-widget">
        <h3>Who to follow</h3>
        <div class="news-item">
          <div class="news-title">Potup Team</div>
          <div class="news-stats">@potup_official</div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI PAGE -->
  <div id="aiPage" class="page">
    <div class="ai-container">
      <div class="ai-header">
        <h2>‚ú® Potup AI Assistant</h2>
        <p>Powered by Google Gemini 2.0 Flash</p>
      </div>
      
      <div class="ai-messages" id="aiMessages">
        <div class="ai-message assistant">
          <div class="ai-message-avatar">
            <span class="material-icons">auto_awesome</span>
          </div>
          <div class="ai-message-bubble">
            Hello! I'm Potup AI, your intelligent assistant. How can I help you today? üåü
          </div>
        </div>
      </div>
      
      <div class="ai-input-container">
        <input type="text" id="aiInput" class="ai-input" placeholder="Ask me anything..." onkeypress="handleAiKeyPress(event)">
        <button class="ai-send-btn" onclick="sendAiMessage()" id="aiSendBtn">
          <span class="material-icons">send</span>
        </button>
      </div>
    </div>
  </div>

  <!-- NOTIFICATIONS PAGE -->
  <div id="notificationsPage" class="page">
    <div style="flex: 1;">
      <div class="page-header">
        <h2>Notifications</h2>
      </div>
      <div id="notificationsList"></div>
    </div>
  </div>

  <!-- PROFILE PAGE -->
  <div id="profilePage" class="page">
    <div style="flex: 1;">
      <div class="page-header">
        <h2>Profile</h2>
        <div class="header-actions">
          <button class="icon-btn-header" onclick="shareProfile()">
            <span class="material-icons" style="font-size: 18px;">share</span>
            <span class="share-text">Share</span>
          </button>
        </div>
      </div>

      <div class="profile-banner"></div>
      
      <div class="profile-info">
        <label for="avatarUpload">
          <img id="profileAvatar" class="profile-avatar" src="https://i.imgur.com/6VBx3io.png">
        </label>
        <input type="file" id="avatarUpload" accept="image/*">

        <div class="profile-details">
          <div class="profile-name">
            <span id="profileName">Username</span>
            <div id="profileBadges"></div>
          </div>
          <div class="profile-username" id="profileUsername">@username</div>
          
          <div class="profile-bio">
            <textarea id="profileBioText" placeholder="Add your bio..." style="width: 100%; background: transparent; border: 1px solid var(--border-color); padding: 12px; border-radius: 12px; color: var(--text-primary); font-size: 15px; resize: vertical; min-height: 80px;" onblur="updateBio()"></textarea>
          </div>

          <div class="profile-stats">
            <div class="stat">
              <span class="stat-value" id="followersCount">0</span>
              <span class="stat-label">Followers</span>
            </div>
            <div class="stat">
              <span class="stat-value" id="followingCount">0</span>
              <span class="stat-label">Following</span>
            </div>
          </div>
          
          <div class="interests-section">
            <h3>Your Interests</h3>
            <div class="interests-grid" id="interestsGrid">
              <button type="button" class="interest-chip" data-interest="fun">üéâ Fun</button>
              <button type="button" class="interest-chip" data-interest="motivation">üí™ Motivation</button>
              <button type="button" class="interest-chip" data-interest="education">üìö Education</button>
              <button type="button" class="interest-chip" data-interest="tech">üíª Tech</button>
              <button type="button" class="interest-chip" data-interest="nature">üåø Nature</button>
              <button type="button" class="interest-chip" data-interest="space">üöÄ Space</button>
              <button type="button" class="interest-chip" data-interest="interesting">‚ú® Interesting</button>
            </div>
            <p class="interests-info">Select up to 3 interests to personalize your feed</p>
          </div>
        </div>
      </div>
      
      <div class="profile-posts-section">
        <div class="profile-posts-header">Your Posts</div>
        <div id="userPosts"></div>
      </div>
    </div>
  </div>

  <!-- VIEW PROFILE PAGE -->
  <div id="viewProfilePage" class="page">
    <div style="flex: 1;">
      <div class="page-header">
        <h2>Profile</h2>
      </div>

      <div class="profile-banner"></div>
      
      <div class="profile-info">
        <img id="viewProfileAvatar" class="profile-avatar" src="https://i.imgur.com/6VBx3io.png">

        <div class="profile-details">
          <div class="profile-name">
            <span id="viewProfileName">Username</span>
            <div id="viewProfileBadges"></div>
          </div>
          <div class="profile-username" id="viewProfileUsername">@username</div>
          
          <div class="profile-bio">
            <p id="viewProfileBio">No bio yet.</p>
          </div>

          <div class="profile-stats">
            <div class="stat">
              <span class="stat-value" id="viewFollowersCount">0</span>
              <span class="stat-label">Followers</span>
            </div>
            <div class="stat">
              <span class="stat-value" id="viewFollowingCount">0</span>
              <span class="stat-label">Following</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="profile-posts-section">
        <div class="profile-posts-header">Posts</div>
        <div id="viewUserPosts"></div>
      </div>
    </div>
  </div>

  <!-- SETTINGS PAGE -->
  <div id="settingsPage" class="page">
    <div style="flex: 1;">
      <div class="page-header">
        <h2>Settings</h2>
      </div>

      <div class="settings-section">
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="material-icons">dark_mode</span>
            <div class="settings-item-text">
              <h4>Dark Mode</h4>
              <p>Toggle between light and dark theme</p>
            </div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="darkModeToggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="material-icons">lock</span>
<a href="ads.html" style="text-decoration: none; color: inherit;">
  <div class="settings-item-text">
    <h4>Do Advertisement</h4>
    <p>Learn how to advertise on Potup</p>
  </div>
</a>
          </div>
          <span class="material-icons" style="color: var(--text-secondary);">chevron_right</span>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="material-icons">workspace_premium</span>
<a href="badges.html" style="text-decoration: none; color: inherit;">
  <div class="settings-item-text">
    <h4>Get Badges</h4>
    <p>Learn How to get Badges on Potup</p>
  </div>
</a>
          </div>
          <span class="material-icons" style="color: var(--text-secondary);">chevron_right</span>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="material-icons">description</span>
<a href="terms-and-conditions.html" style="text-decoration: none; color: inherit;">
  <div class="settings-item-text">
    <h4>Terms and Conditions</h4>
    <p>Read our terms of service</p>
  </div>
</a>
          </div>
          <span class="material-icons" style="color: var(--text-secondary);">chevron_right</span>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-item">
          <div class="settings-item-left">
            <span class="material-icons">help</span>
<a href="privacy-and-security.html" style="text-decoration: none; color: inherit;">
  <div class="settings-item-text">
    <h4>Support</h4>
    <p>Get help with your account</p>
  </div>
</a>
          </div>
          <span class="material-icons" style="color: var(--text-secondary);">chevron_right</span>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-item" onclick="logout()">
          <div class="settings-item-left">
            <span class="material-icons" style="color: var(--founder);">logout</span>
            <div class="settings-item-text">
              <h4 style="color: var(--founder);">Log Out</h4>
              <p>Sign out of your account</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- PROFILE MODAL -->
<div id="profileModal">
  <div class="modal-box">
    <span class="close" onclick="closeProfile()">‚úï</span>
    <img id="modalAvatar" class="modal-avatar">
    <div class="modal-content">
      <div class="modal-username" id="modalUserId"></div>
      <div id="modalBadges" class="modal-badges"></div>
      <p id="modalBio" class="modal-bio"></p>
      <div class="modal-actions">
        <button id="followBtn" class="modal-follow-btn"></button>
        <button class="modal-share-btn" onclick="shareModalProfile()">
          <span class="material-icons" style="font-size: 18px; vertical-align: middle;">share</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://hdauaegfmenlzhqnfgvy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkYXVhZWdmbWVubHpocW5mZ3Z5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDc0MzAsImV4cCI6MjA4MTAyMzQzMH0.8IHXBnKm6pE5cwBGPo7m0eIWdtVPsQDL1CUozebpNDE";
const IMGBB_API_KEY = "9360a2ebd6e3f0d47def9d8d34db622b";
const GEMINI_API_KEY = "AIzaSyDxv_Mz7vLG6vSMTECt8rOQfKAUOh74CBs";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const userUUID = localStorage.getItem("id");
let myUserIdText = null;
let viewedUUID = null;
let currentUserData = null;
let allPosts = [];
let displayedPostsCount = 0;
const POSTS_PER_LOAD = 10;
let isLoading = false;
let emojisLoaded = false;
let allEmojis = [];
let selectedPostCategory = null;
let userInterests = [];
let unreadNotifications = 0;
let aiConversationHistory = [];
let userLikes = new Set();

document.addEventListener("DOMContentLoaded", async () => {
  if (!userUUID) {
    const urlParams = new URLSearchParams(window.location.search);
    const profileId = urlParams.get('profile');
    if (profileId) {
      await loadSharedProfile(profileId);
      return;
    }
    location.href = "log-in.html";
    return;
  }
  
  const darkMode = localStorage.getItem("darkMode") !== "false";
  document.getElementById("darkModeToggle").checked = darkMode;
  if (!darkMode) {
    document.body.classList.add("light-mode");
  }
  
  await loadProfile();
  await loadUserLikes();
  await loadAllPosts();
  displayPosts();
  await loadNotifications();
  
  setupNavigation();
  setupMobileNavigation();
  setupDarkMode();
  setupAvatarUpload();
  setupInfiniteScroll();
  setupEmojiPicker();
  setupCategorySelector();
  setupInterestsSelector();
  
  setupRealtimeNotifications();
});

function setupNavigation() {
  document.querySelectorAll(".nav-item").forEach(item => {
    item.addEventListener("click", async () => {
      document.querySelectorAll(".nav-item").forEach(i => i.classList.remove("active"));
      item.classList.add("active");
      
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      
      const pageId = item.getAttribute("data-page");
      document.getElementById(pageId).classList.add("active");
      
      if (pageId === "profilePage") {
        await loadProfilePage();
        await loadUserPosts();
      } else if (pageId === "notificationsPage") {
        await markNotificationsAsRead();
        await loadNotifications();
      }
    });
  });
}

function setupMobileNavigation() {
  document.querySelectorAll(".mobile-nav-item").forEach(item => {
    item.addEventListener("click", async () => {
      document.querySelectorAll(".mobile-nav-item").forEach(i => i.classList.remove("active"));
      item.classList.add("active");
      
      document.querySelectorAll(".nav-item").forEach(i => i.classList.remove("active"));
      
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      
      const pageId = item.getAttribute("data-page");
      document.getElementById(pageId).classList.add("active");
      
      const matchingNavItem = document.querySelector(`.nav-item[data-page="${pageId}"]`);
      if (matchingNavItem) {
        matchingNavItem.classList.add("active");
      }
      
      if (pageId === "profilePage") {
        await loadProfilePage();
        await loadUserPosts();
      } else if (pageId === "notificationsPage") {
        await markNotificationsAsRead();
        await loadNotifications();
      }
    });
  });
}

function setupDarkMode() {
  document.getElementById("darkModeToggle").addEventListener("change", (e) => {
    if (e.target.checked) {
      document.body.classList.remove("light-mode");
      localStorage.setItem("darkMode", "true");
    } else {
      document.body.classList.add("light-mode");
      localStorage.setItem("darkMode", "false");
    }
  });
}

function setupCategorySelector() {
  const categoryOptions = document.querySelectorAll('#postCategoryOptions .category-option');
  
  categoryOptions.forEach(option => {
    option.addEventListener('click', () => {
      categoryOptions.forEach(opt => opt.classList.remove('selected'));
      option.classList.add('selected');
      selectedPostCategory = option.getAttribute('data-category');
    });
  });
}

function setupInterestsSelector() {
  const interestChips = document.querySelectorAll('#interestsGrid .interest-chip');
  
  interestChips.forEach(chip => {
    chip.addEventListener('click', async () => {
      const interest = chip.getAttribute('data-interest');
      
      if (chip.classList.contains('selected')) {
        chip.classList.remove('selected');
        userInterests = userInterests.filter(i => i !== interest);
      } else {
        if (userInterests.length >= 3) {
          alert('You can select up to 3 interests only!');
          return;
        }
        chip.classList.add('selected');
        userInterests.push(interest);
      }
      
      interestChips.forEach(c => {
        if (!c.classList.contains('selected')) {
          c.disabled = userInterests.length >= 3;
        }
      });
      
      await saveInterests();
    });
  });
}

async function saveInterests() {
  await sb.from("user_profiles")
    .update({ interests: userInterests.join(',') })
    .eq("id", userUUID);
  
  currentUserData.interests = userInterests.join(',');
  
  document.getElementById("feed").innerHTML = "";
  displayedPostsCount = 0;
  await loadAllPosts();
  displayPosts();
}

function loadInterestsUI() {
  const interestChips = document.querySelectorAll('#interestsGrid .interest-chip');
  
  interestChips.forEach(chip => {
    const interest = chip.getAttribute('data-interest');
    if (userInterests.includes(interest)) {
      chip.classList.add('selected');
    } else {
      chip.classList.remove('selected');
    }
    chip.disabled = userInterests.length >= 3 && !chip.classList.contains('selected');
  });
}

function setupInfiniteScroll() {
  const feedScrollArea = document.querySelector('.feed-scroll-area');
  
  feedScrollArea.addEventListener('scroll', () => {
    if (isLoading) return;
    
    const scrollTop = feedScrollArea.scrollTop;
    const scrollHeight = feedScrollArea.scrollHeight;
    const clientHeight = feedScrollArea.clientHeight;
    
    if (scrollTop + clientHeight >= scrollHeight - 200) {
      if (displayedPostsCount < allPosts.length) {
        displayPosts();
      }
    }
  });
}

async function loadProfile() {
  const { data } = await sb
    .from("user_profiles")
    .select("*")
    .eq("id", userUUID)
    .single();

  currentUserData = data;
  myUserIdText = data.user_id;
  
  if (data.interests) {
    userInterests = data.interests.split(',').filter(i => i.trim());
  } else {
    userInterests = [];
  }
  
  const avatarUrl = data.avatar_url || "https://i.imgur.com/6VBx3io.png";
  document.getElementById("composerAvatar").src = avatarUrl;
}

async function loadUserLikes() {
  const { data } = await sb
    .from("likes")
    .select("post_id")
    .eq("user_id", userUUID);
  
  if (data) {
    userLikes = new Set(data.map(like => like.post_id));
  }
}

async function loadProfilePage() {
  if (!currentUserData) return;
  
  const avatarUrl = currentUserData.avatar_url || "https://i.imgur.com/6VBx3io.png";
  document.getElementById("profileAvatar").src = avatarUrl;
  document.getElementById("profileName").innerText = currentUserData.user_id;
  document.getElementById("profileUsername").innerText = "@" + currentUserData.user_id;
  document.getElementById("profileBioText").value = currentUserData.bio || "";
  document.getElementById("followersCount").innerText = currentUserData.followers || 0;
  
  const { data: followingData } = await sb
    .from("follows")
    .select("id")
    .eq("follower_id", userUUID);
  document.getElementById("followingCount").innerText = followingData ? followingData.length : 0;
  
  const badgesContainer = document.getElementById("profileBadges");
  badgesContainer.innerHTML = "";
  if (currentUserData.badges) {
    currentUserData.badges.split(",").forEach(b => {
      const badge = b.trim().toLowerCase();
      badgesContainer.innerHTML += `<span class="badge ${badge}">${b.trim()}</span>`;
    });
  }
  
  loadInterestsUI();
}

async function loadUserPosts() {
  const { data: posts } = await sb
    .from("posts")
    .select("*")
    .eq("author", myUserIdText)
    .order("created_at", { ascending: false });
  
  const userPostsContainer = document.getElementById("userPosts");
  userPostsContainer.innerHTML = "";
  
  if (!posts || posts.length === 0) {
    userPostsContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">No posts yet</div>';
    return;
  }
  
  // Get actual like counts for user posts
  const postIds = posts.map(p => p.id);
  const { data: likeCounts } = await sb
    .from("likes")
    .select("post_id")
    .in("post_id", postIds);
  
  const likeCountMap = {};
  if (likeCounts) {
    likeCounts.forEach(like => {
      likeCountMap[like.post_id] = (likeCountMap[like.post_id] || 0) + 1;
    });
  }
  
  posts.forEach(p => {
    const avatarUrl = currentUserData.avatar_url || "https://i.imgur.com/6VBx3io.png";
    
    let badgesHTML = "";
    if (currentUserData.badges) {
      currentUserData.badges.split(",").forEach(b => {
        const badge = b.trim().toLowerCase();
        badgesHTML += `<span class="badge ${badge}">${b.trim()}</span>`;
      });
    }
    
    const timeAgo = getTimeAgo(new Date(p.created_at));
    const categoryEmojis = {
      'fun': 'üéâ',
      'motivation': 'üí™',
      'education': 'üìö',
      'tech': 'üíª',
      'nature': 'üåø',
      'space': 'üöÄ',
      'interesting': '‚ú®',
      'other': 'üìù'
    };
    const categoryLabel = p.type ? `${categoryEmojis[p.type] || ''} ${p.type}` : '';
    
    const isLiked = userLikes.has(p.id);
    const likeIcon = isLiked ? 'favorite' : 'favorite_border';
    const likeClass = isLiked ? 'liked' : '';
    const likeCount = likeCountMap[p.id] || 0; // Use actual count from likes table
    
    const postElement = document.createElement('div');
    postElement.className = 'post';
    postElement.innerHTML = `
      <div class="post-content-wrapper">
        <img class="post-avatar" src="${avatarUrl}">
        <div class="post-main">
          <div class="post-header">
            <span class="username">${p.author}</span>
            ${badgesHTML}
            <span class="post-time">¬∑ ${timeAgo}</span>
            ${categoryLabel ? `<span class="post-category">${categoryLabel}</span>` : ''}
          </div>
          <p class="post-text">${p.content || ""}</p>
          ${p.image_url ? `<img class="post-img" src="${p.image_url}">` : ""}
          <div class="post-actions">
            <button class="action-btn ${likeClass}" onclick="toggleLike('${p.id}', this)" data-post-id="${p.id}">
              <span class="material-icons">${likeIcon}</span>
              <span class="like-count">${likeCount}</span>
            </button>
          </div>
        </div>
      </div>
    `;
    
    userPostsContainer.appendChild(postElement);
  });
}

async function updateBio() {
  const bio = document.getElementById("profileBioText").value;
  await sb.from("user_profiles").update({ bio }).eq("id", userUUID);
  currentUserData.bio = bio;
}

function setupAvatarUpload() {
  document.getElementById("avatarUpload").addEventListener("change", async (e) => {
    if (e.target.files[0]) {
      const imageUrl = await uploadImage(e.target.files[0]);
      await sb.from("user_profiles").update({ avatar_url: imageUrl }).eq("id", userUUID);
      document.getElementById("profileAvatar").src = imageUrl;
      document.getElementById("composerAvatar").src = imageUrl;
      currentUserData.avatar_url = imageUrl;
    }
  });
}

async function loadAllPosts() {
  const { data: posts } = await sb
    .from("posts")
    .select("*")
    .order("created_at", { ascending: false });
    
  const { data: profiles } = await sb
    .from("user_profiles")
    .select("user_id, avatar_url, badges");

  // Get actual like counts for each post
  const postIds = posts.map(p => p.id);
  const { data: likeCounts } = await sb
    .from("likes")
    .select("post_id")
    .in("post_id", postIds);
  
  // Count likes per post
  const likeCountMap = {};
  if (likeCounts) {
    likeCounts.forEach(like => {
      likeCountMap[like.post_id] = (likeCountMap[like.post_id] || 0) + 1;
    });
  }

  let enrichedPosts = posts.map(p => {
    const prof = profiles.find(u => u.user_id === p.author) || {};
    return {
      ...p,
      profile: prof,
      actualLikes: likeCountMap[p.id] || 0 // Add actual like count
    };
  });
  
  allPosts = applySmartAlgorithm(enrichedPosts);
  displayedPostsCount = 0;
}

function applySmartAlgorithm(posts) {
  const adPosts = posts.filter(p => p.profile.badges && p.profile.badges.toLowerCase().includes('ad'));
  const regularPosts = posts.filter(p => !(p.profile.badges && p.profile.badges.toLowerCase().includes('ad')));
  
  let relevantAdPosts = adPosts;
  if (userInterests.length > 0) {
    const interestedAds = adPosts.filter(p => userInterests.includes(p.type));
    const otherAds = adPosts.filter(p => !userInterests.includes(p.type));
    relevantAdPosts = [...shuffleArray(interestedAds), ...shuffleArray(otherAds)];
  } else {
    relevantAdPosts = shuffleArray(adPosts);
  }
  
  let sortedRegularPosts;
  if (userInterests.length === 0) {
    sortedRegularPosts = shuffleArray(regularPosts);
  } else {
    const interestedPosts = regularPosts.filter(p => userInterests.includes(p.type));
    const otherPosts = regularPosts.filter(p => !userInterests.includes(p.type));
    sortedRegularPosts = [...shuffleArray(interestedPosts), ...shuffleArray(otherPosts)];
  }
  
  const finalPosts = [];
  let adIndex = 0;
  
  for (let i = 0; i < sortedRegularPosts.length; i++) {
    finalPosts.push(sortedRegularPosts[i]);
    
    if ((i + 1) % 10 === 0 && adIndex < relevantAdPosts.length) {
      finalPosts.push(relevantAdPosts[adIndex]);
      adIndex++;
    }
  }
  
  while (adIndex < relevantAdPosts.length) {
    finalPosts.push(relevantAdPosts[adIndex]);
    adIndex++;
  }
  
  return finalPosts;
}

function shuffleArray(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

function displayPosts() {
  if (isLoading) return;
  isLoading = true;
  
  const feed = document.getElementById("feed");
  const postsToShow = allPosts.slice(displayedPostsCount, displayedPostsCount + POSTS_PER_LOAD);
  
  postsToShow.forEach(p => {
    const avatarUrl = p.profile.avatar_url || "https://i.imgur.com/6VBx3io.png";
    
    let badgesHTML = "";
    if (p.profile.badges) {
      p.profile.badges.split(",").forEach(b => {
        const badge = b.trim().toLowerCase();
        badgesHTML += `<span class="badge ${badge}">${b.trim()}</span>`;
      });
    }
    
    const timeAgo = getTimeAgo(new Date(p.created_at));
    const categoryEmojis = {
      'fun': 'üéâ',
      'motivation': 'üí™',
      'education': 'üìö',
      'tech': 'üíª',
      'nature': 'üåø',
      'space': 'üöÄ',
      'interesting': '‚ú®',
      'other': 'üìù'
    };
    const categoryLabel = p.type ? `${categoryEmojis[p.type] || ''} ${p.type}` : '';
    
    const isLiked = userLikes.has(p.id);
    const likeIcon = isLiked ? 'favorite' : 'favorite_border';
    const likeClass = isLiked ? 'liked' : '';
    const likeCount = p.actualLikes || 0; // Use actualLikes instead of p.likes
    
    const postElement = document.createElement('div');
    postElement.className = 'post';
    postElement.innerHTML = `
      <div class="post-content-wrapper">
        <img class="post-avatar" src="${avatarUrl}">
        <div class="post-main">
          <div class="post-header">
            <span class="username" onclick="openProfile('${p.author}')">${p.author}</span>
            ${badgesHTML}
            <span class="post-time">¬∑ ${timeAgo}</span>
            ${categoryLabel ? `<span class="post-category">${categoryLabel}</span>` : ''}
          </div>
          <p class="post-text">${p.content || ""}</p>
          ${p.image_url ? `<img class="post-img" src="${p.image_url}">` : ""}
          <div class="post-actions">
            <button class="action-btn ${likeClass}" onclick="toggleLike('${p.id}', this)" data-post-id="${p.id}">
              <span class="material-icons">${likeIcon}</span>
              <span class="like-count">${likeCount}</span>
            </button>
          </div>
        </div>
      </div>
    `;
    
    feed.appendChild(postElement);
  });
  
  displayedPostsCount += postsToShow.length;
  isLoading = false;
}

function getTimeAgo(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  const intervals = {
    year: 31536000,
    month: 2592000,
    week: 604800,
    day: 86400,
    hour: 3600,
    minute: 60
  };
  
  for (let [unit, secondsInUnit] of Object.entries(intervals)) {
    const interval = Math.floor(seconds / secondsInUnit);
    if (interval >= 1) {
      return interval === 1 ? `1 ${unit} ago` : `${interval} ${unit}s ago`;
    }
  }
  return "just now";
}

async function createPost() {
  const content = document.getElementById("postContent").value;
  
  if (!content.trim()) {
    alert('Please write something!');
    return;
  }
  
  if (!selectedPostCategory) {
    alert('Please select a category for your post!');
    return;
  }
  
  let imageUrl = null;
  const fileInput = document.getElementById("postImage");
  if (fileInput.files[0]) {
    imageUrl = await uploadImage(fileInput.files[0]);
  }

  await sb.from("posts").insert({
    author: myUserIdText,
    content: content,
    image_url: imageUrl,
    type: selectedPostCategory,
    likes: 0
  });

  document.getElementById("postContent").value = "";
  fileInput.value = "";
  selectedPostCategory = null;
  document.querySelectorAll('#postCategoryOptions .category-option').forEach(opt => {
    opt.classList.remove('selected');
  });
  
  document.getElementById("feed").innerHTML = "";
  await loadAllPosts();
  displayPosts();
}

async function toggleLike(postId, buttonElement) {
  if (buttonElement.disabled) return;
  buttonElement.disabled = true;
  
  const isCurrentlyLiked = userLikes.has(postId);
  
  try {
    if (isCurrentlyLiked) {
      await sb
        .from("likes")
        .delete()
        .eq("post_id", postId)
        .eq("user_id", userUUID);
      
      await sb.rpc("decrement_post_likes", { post_id: postId });
      
      userLikes.delete(postId);
      
      const icon = buttonElement.querySelector('.material-icons');
      const count = buttonElement.querySelector('.like-count');
      icon.textContent = 'favorite_border';
      buttonElement.classList.remove('liked');
      count.textContent = Math.max(0, parseInt(count.textContent) - 1);
      
    } else {
      await sb
        .from("likes")
        .insert({
          post_id: postId,
          user_id: userUUID
        });
      
      await sb.rpc("increment_post_likes", { post_id: postId });
      
      userLikes.add(postId);
      
      const icon = buttonElement.querySelector('.material-icons');
      const count = buttonElement.querySelector('.like-count');
      icon.textContent = 'favorite';
      buttonElement.classList.add('liked');
      count.textContent = parseInt(count.textContent) + 1;
    }
  } catch (error) {
    console.error('Error toggling like:', error);
    showToast('Failed to update like. Please try again.');
  } finally {
    buttonElement.disabled = false;
  }
}

async function loadNotifications() {
  const { data: notifications } = await sb
    .from("notifications")
    .select("*")
    .eq("user_id", userUUID)
    .order("created_at", { ascending: false })
    .limit(50);
  
  const notificationsList = document.getElementById("notificationsList");
  
  if (!notifications || notifications.length === 0) {
    notificationsList.innerHTML = `
      <div class="no-notifications">
        <span class="material-icons" style="font-size: 48px; margin-bottom: 16px;">notifications_none</span>
        <p>No notifications yet</p>
      </div>
    `;
    return;
  }
  
  notificationsList.innerHTML = "";
  
  notifications.forEach(notif => {
    const iconClass = notif.type === 'follow' ? 'follow' : 'system';
    const icon = notif.type === 'follow' ? 'person_add' : 'campaign';
    const timeAgo = getTimeAgo(new Date(notif.created_at));
    
    const notifElement = document.createElement('div');
    notifElement.className = `notification-item ${notif.read ? '' : 'unread'}`;
    notifElement.innerHTML = `
      <div class="notification-icon ${iconClass}">
        <span class="material-icons">${icon}</span>
      </div>
      <div class="notification-content">
        <div class="notification-text">${notif.message}</div>
        <div class="notification-time">${timeAgo}</div>
      </div>
    `;
    
    if (notif.from_user) {
      notifElement.onclick = () => openProfile(notif.from_user);
    }
    
    notificationsList.appendChild(notifElement);
  });
  
  updateNotificationBadge();
}

async function updateNotificationBadge() {
  const { count } = await sb
    .from("notifications")
    .select("id", { count: 'exact' })
    .eq("user_id", userUUID)
    .eq("read", false);
  
  const badge = document.getElementById("notificationBadge");
  const mobileBadge = document.getElementById("mobileNotificationBadge");
  
  if (count > 0) {
    const displayCount = count > 99 ? '99+' : count;
    badge.textContent = displayCount;
    badge.classList.remove("hidden");
    mobileBadge.textContent = displayCount;
    mobileBadge.classList.remove("hidden");
  } else {
    badge.classList.add("hidden");
    mobileBadge.classList.add("hidden");
  }
  
  unreadNotifications = count;
}

async function markNotificationsAsRead() {
  await sb
    .from("notifications")
    .update({ read: true })
    .eq("user_id", userUUID)
    .eq("read", false);
  
  updateNotificationBadge();
}

function setupRealtimeNotifications() {
  sb.channel('notifications')
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'notifications',
      filter: `user_id=eq.${userUUID}`
    }, (payload) => {
      updateNotificationBadge();
      showToast(payload.new.message);
    })
    .subscribe();
}

function showToast(message) {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    bottom: 80px;
    right: 20px;
    left: 20px;
    max-width: 400px;
    margin: 0 auto;
    background: var(--accent);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    font-size: 14px;
    z-index: 10000;
    animation: slideIn 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

async function sendAiMessage() {
  const input = document.getElementById("aiInput");
  const message = input.value.trim();
  
  if (!message) return;
  
  const messagesContainer = document.getElementById("aiMessages");
  const sendBtn = document.getElementById("aiSendBtn");
  
  addAiMessage('user', message);
  input.value = "";
  sendBtn.disabled = true;
  
  const typingIndicator = document.createElement('div');
  typingIndicator.className = 'ai-message assistant';
  typingIndicator.id = 'typing-indicator';
  typingIndicator.innerHTML = `
    <div class="ai-message-avatar">
      <span class="material-icons">auto_awesome</span>
    </div>
    <div class="ai-message-bubble">
      <div class="ai-typing">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  `;
  messagesContainer.appendChild(typingIndicator);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        contents: [
          {
            parts: [
              {
                text: message
              }
            ]
          }
        ],
        generationConfig: {
          temperature: 1,
          topK: 40,
          topP: 0.95,
          maxOutputTokens: 8192
        }
      })
    });
    
    const data = await response.json();
    
    document.getElementById('typing-indicator')?.remove();
    
    if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
      const aiResponse = data.candidates[0].content.parts[0].text;
      addAiMessage('assistant', aiResponse);
    } else if (data.error) {
      addAiMessage('assistant', `Error: ${data.error.message}. Please check your API key or try again.`);
    } else {
      addAiMessage('assistant', "I'm sorry, I couldn't process that request. Please try again.");
    }
    
  } catch (error) {
    console.error('AI Error:', error);
    document.getElementById('typing-indicator')?.remove();
    addAiMessage('assistant', "Sorry, I'm having trouble connecting right now. Please try again later.");
  }
  
  sendBtn.disabled = false;
}

function addAiMessage(role, content) {
  const messagesContainer = document.getElementById("aiMessages");
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `ai-message ${role}`;
  
  const avatar = role === 'assistant' 
    ? '<span class="material-icons">auto_awesome</span>'
    : '<span class="material-icons">person</span>';
  
  const formattedContent = content
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/\n/g, '<br>');
  
  messageDiv.innerHTML = `
    <div class="ai-message-avatar">
      ${avatar}
    </div>
    <div class="ai-message-bubble">${formattedContent}</div>
`;
messagesContainer.appendChild(messageDiv);
messagesContainer.scrollTop = messagesContainer.scrollHeight;
}
function handleAiKeyPress(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendAiMessage();
  }
}
async function openProfile(userIdText) {
  const { data } = await sb
    .from("user_profiles")
    .select("*")
    .eq("user_id", userIdText)
    .single();
  if (!data) return;
  viewedUUID = data.id;
  document.getElementById("modalAvatar").src = data.avatar_url || "https://i.imgur.com/6VBx3io.png";
  document.getElementById("modalUserId").innerText = data.user_id;
  document.getElementById("modalBio").innerText = data.bio || "No bio yet.";
  const modalBadges = document.getElementById("modalBadges");
  modalBadges.innerHTML = "";
  if (data.badges) {
    data.badges.split(",").forEach(b => {
      const badge = b.trim().toLowerCase();
      modalBadges.innerHTML += `<span class="badge ${badge}">${b.trim()}</span>`;
    });
  }
  await updateFollowBtn();
  document.getElementById("profileModal").style.display = "flex";
}
function closeProfile() {
  document.getElementById("profileModal").style.display = "none";
}
async function updateFollowBtn() {
  const followBtn = document.getElementById("followBtn");
  if (viewedUUID === userUUID) {
    followBtn.style.display = "none";
    return;
  }
  const { data } = await sb
    .from("follows")
    .select("id")
    .eq("follower_id", userUUID)
    .eq("following_id", viewedUUID)
    .maybeSingle();
  followBtn.style.display = "inline-block";
  followBtn.innerText = data ? "Unfollow" : "Follow";
  followBtn.onclick = toggleFollow;
}
async function toggleFollow() {
  const { data } = await sb
    .from("follows")
    .select("id")
    .eq("follower_id", userUUID)
    .eq("following_id", viewedUUID)
    .maybeSingle();
  if (data) {
    await sb.from("follows").delete().eq("id", data.id);
    await sb.rpc("decrement_followers", { uid: viewedUUID });
  } else {
    await sb.from("follows").insert({
      follower_id: userUUID,
      following_id: viewedUUID
    });
    await sb.rpc("increment_followers", { uid: viewedUUID });
    await sb.from("notifications").insert({
      user_id: viewedUUID,
      type: 'follow',
      message: `<strong>${myUserIdText}</strong> started following you`,
      from_user: myUserIdText,
      read: false
    });
  }
  await updateFollowBtn();
  await loadProfile();
  await loadProfilePage();
}
function shareProfile() {
  const profileUrl = `${window.location.origin}${window.location.pathname}?profile=${userUUID}`;
  copyToClipboard(profileUrl);
  showToast('Profile link copied to clipboard!');
}
function shareModalProfile() {
  const profileUrl = `${window.location.origin}${window.location.pathname}?profile=${viewedUUID}`;
  copyToClipboard(profileUrl);
  showToast('Profile link copied to clipboard!');
}
function copyToClipboard(text) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).catch(() => {
      fallbackCopyToClipboard(text);
    });
  } else {
    fallbackCopyToClipboard(text);
  }
}
function fallbackCopyToClipboard(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  document.execCommand('copy');
  document.body.removeChild(textarea);
}
async function loadSharedProfile(profileId) {
  const { data: profile } = await sb
    .from("user_profiles")
    .select("*")
    .eq("id", profileId)
    .single();
  if (!profile) {
    document.body.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100vh; color: var(--text-primary);">Profile not found</div>';
    return;
  }
  document.querySelector('nav').style.display = 'none';
  document.querySelector('.mobile-nav').style.display = 'none';
  document.getElementById('viewProfilePage').classList.add('active');
  const avatarUrl = profile.avatar_url || "https://i.imgur.com/6VBx3io.png";
  document.getElementById("viewProfileAvatar").src = avatarUrl;
  document.getElementById("viewProfileName").innerText = profile.user_id;
  document.getElementById("viewProfileUsername").innerText = "@" + profile.user_id;
  document.getElementById("viewProfileBio").innerText = profile.bio || "No bio yet.";
  document.getElementById("viewFollowersCount").innerText = profile.followers || 0;
  const { data: followingData } = await sb
    .from("follows")
    .select("id")
    .eq("follower_id", profileId);
  document.getElementById("viewFollowingCount").innerText = followingData ? followingData.length : 0;
  const badgesContainer = document.getElementById("viewProfileBadges");
  badgesContainer.innerHTML = "";
  if (profile.badges) {
    profile.badges.split(",").forEach(b => {
      const badge = b.trim().toLowerCase();
      badgesContainer.innerHTML += `<span class="badge ${badge}">${b.trim()}</span>`;
    });
  }
  const { data: posts } = await sb
    .from("posts")
    .select("*")
    .eq("author", profile.user_id)
    .order("created_at", { ascending: false });
  const viewUserPostsContainer = document.getElementById("viewUserPosts");
  if (!posts || posts.length === 0) {
    viewUserPostsContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">No posts yet</div>';
    return;
  }
  posts.forEach(p => {
    let badgesHTML = "";
    if (profile.badges) {
      profile.badges.split(",").forEach(b => {
        const badge = b.trim().toLowerCase();
        badgesHTML += `<span class="badge ${badge}">${b.trim()}</span>`;
      });
    }
    const timeAgo = getTimeAgo(new Date(p.created_at));
    const categoryEmojis = {
      'fun': 'üéâ',
      'motivation': 'üí™',
      'education': 'üìö',
      'tech': 'üíª',
      'nature': 'üåø',
      'space': 'üöÄ',
      'interesting': '‚ú®',
      'other': 'üìù'
    };
    const categoryLabel = p.type ? `${categoryEmojis[p.type] || ''} ${p.type}` : '';

    const postElement = document.createElement('div');
    postElement.className = 'post';
    postElement.innerHTML = `
      <div class="post-content-wrapper">
        <img class="post-avatar" src="${avatarUrl}">
        <div class="post-main">
          <div class="post-header">
            <span class="username">${p.author}</span>
            ${badgesHTML}
            <span class="post-time">¬∑ ${timeAgo}</span>
            ${categoryLabel ? `<span class="post-category">${categoryLabel}</span>` : ''}
          </div>
          <p class="post-text">${p.content || ""}</p>
          ${p.image_url ? `<img class="post-img" src="${p.image_url}">` : ""}
        </div>
      </div>
    `;

    viewUserPostsContainer.appendChild(postElement);
  });
}
async function uploadImage(file) {
  const fd = new FormData();
  fd.append("image", file);
  const r = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
    method: "POST",
    body: fd
  });
  const json = await r.json();
  return json.data.url;
}
function logout() {
  localStorage.removeItem("id");
  location.href = "log-in.html";
}
function setupEmojiPicker() {
  const emojiBtn = document.getElementById('emojiBtn');
  const emojiPicker = document.getElementById('emojiPicker');
  emojiBtn.addEventListener('click', async (e) => {
    e.stopPropagation();
    const isVisible = emojiPicker.style.display === 'block';
    emojiPicker.style.display = isVisible ? 'none' : 'block';
    if (!emojisLoaded && !isVisible) {
      await loadEmojis();
    }
  });
  document.addEventListener('click', (e) => {
    if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
      emojiPicker.style.display = 'none';
    }
  });
}
async function loadEmojis() {
  const emojiGrid = document.getElementById('emojiGrid');
  emojiGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading emojis...</div>';
  try {
    const categories = [
      'face-positive',
      'face-negative',
      'face-neutral',
      'hand-prop',
      'person-gesture'
    ];
    const allEmojiPromises = categories.map(category =>
      fetch(`https://emojihub.yurace.pro/api/all/group/${category}`)
        .then(res => res.ok ? res.json() : [])
        .catch(() => [])
    );

    const results = await Promise.all(allEmojiPromises);
    allEmojis = results.flat();

    if (allEmojis.length === 0) {
      throw new Error("No emojis loaded");
    }

    emojiGrid.innerHTML = '';

    allEmojis.forEach(emoji => {
      const charCode = emoji.htmlCode[0];
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = charCode;
      const emojiCharacter = tempDiv.textContent;

      const button = document.createElement('button');
      button.className = 'emoji-btn-item';
      button.innerHTML = emojiCharacter;
      button.title = emoji.name || '';

      button.addEventListener('click', (e) => {
        e.stopPropagation();
        insertEmoji(emojiCharacter);
      });

      emojiGrid.appendChild(button);
    });

    emojisLoaded = true;
  } catch (error) {
    console.error('Could not fetch emojis:', error);
    emojiGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Failed to load emojis üòû</div>';
  }
}
function insertEmoji(emoji) {
  const postContent = document.getElementById('postContent');
  const start = postContent.selectionStart;
  const end = postContent.selectionEnd;
  const newText = postContent.value.substring(0, start) + emoji + postContent.value.substring(end);
  postContent.value = newText;
  postContent.selectionStart = postContent.selectionEnd = start + emoji.length;
  postContent.focus();
}
document.addEventListener('contextmenu', function (e) {
  e.preventDefault();
});
document.addEventListener('keydown', function (e) {
  if (
    e.key === 'F12' ||
    (e.ctrlKey && e.shiftKey && ['I', 'C', 'J'].includes(e.key)) ||
    (e.ctrlKey && e.key === 'U')
  ) {
    e.preventDefault();
  }
});
</script>
</body>
</html>